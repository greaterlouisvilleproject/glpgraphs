```{r setup}
library(glptools)
library(glpdata)
glp_load_packages(graphs = T)

showtext_auto()
font_add("Museo Sans 300", "MuseoSans_300.otf")
font_add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

source("helpers/graph_functions.R")
source("helpers/load_graph_specs.R")
graph_specs <- load_graph_specs()
```

```{r}
# create_images(column = "variable", 
#               value = c("loan_amount_pp", "loan_number_per_100"),
#               upload_graphs = F,
#               upload_data   = F)


hl_amount_ylims <- get_y_lims(home_loan_county, "loan_amount_pp")
hl_amount_prefix <- "qop/loan_amount_pp/loan_amount_pp"

hl_num_ylims <- get_y_lims(home_loan_county, "loan_number_per_100")
hl_num_prefix <- "qop/loan_number_per_100/loan_number_per_100"

hl_denial_ylims <- get_y_lims(home_loan_county, "denial")
hl_denial_prefix <- "qop/denial/denial"


graph_ranking("loan_amount_pp",                                  file_prefix = hl_amount_prefix)
graph_trendline("loan_amount_pp", ylims = hl_amount_ylims$ylims, file_prefix = hl_amount_prefix)
graph_maxmin("loan_amount_pp",    ylims = hl_amount_ylims$ylims, file_prefix = hl_amount_prefix)
graph_sex("loan_amount_pp",       ylims = hl_amount_ylims$ylims, file_prefix = hl_amount_prefix, year_breaks = 2017.5)
graph_race("loan_amount_pp",      ylims = hl_amount_ylims$ylims, file_prefix = hl_amount_prefix, year_breaks = 2017.5)

graph_ranking("loan_number_per_100",                               file_prefix = hl_num_prefix)
graph_trendline("loan_number_per_100", ylims = hl_num_ylims$ylims, file_prefix = hl_num_prefix)
graph_maxmin("loan_number_per_100",    ylims = hl_num_ylims$ylims, file_prefix = hl_num_prefix)
graph_sex("loan_number_per_100",       ylims = hl_num_ylims$ylims, file_prefix = hl_num_prefix, year_breaks = 2017.5)
graph_race("loan_number_per_100",      ylims = hl_num_ylims$ylims, file_prefix = hl_num_prefix, year_breaks = 2017.5)


graph_ranking("denial",                                   file_prefix = hl_denial_prefix)
graph_trendline("denial", ylims = hl_denial_ylims$ylims, file_prefix = hl_denial_prefix)
graph_maxmin("denial",    ylims = hl_denial_ylims$ylims,  file_prefix = hl_denial_prefix)
graph_sex("denial",       ylims = hl_denial_ylims$ylims,  file_prefix = hl_denial_prefix, 
          year_breaks = 2017.5)
graph_race("denial",      ylims = hl_denial_ylims$ylims,  file_prefix = hl_denial_prefix, 
           year_breaks = 2017.5)


```

```{r net_mig}
HPI_graph <- graph_specs %>% filter(variable == "HPI")

png("images/qop/HPI/HPI_ranking.png", 3000, 2400, res = 200)
ranking(qop_county,
        "HPI",
        "Housing Price Index",
        y_title = HPI_graph$units,
        caption = HPI_graph$caption,
        accuracy = 1,
        ranking_order = F)
dev.off()
```

```{r}
map_tract <- glpdata::map_tract
map_tract@data %<>%
        select(GEO_ID, tract, neighborhood) %>% 
        left_join(filter(glpdata:::home_loan_tract, year == 2018), by = c("GEO_ID" = "tract"))

make_map(list(tract = map_tract), "loan_amount_pp", "Loans per person", "Loans per capita", "Dollars",
         continuous = F, var_bins = c(0, 100, 500, 2500, 5000, 10000, 20000), tiles = F)

```

```{r housing}
create_images(column = "variable", 
              value = c("severe_housing_problems", "homeownership", "cost_burden"),
              upload_graphs = T,
              upload_data   = F)
```

```{r homeownership}
path <- "output_images/qop/homeownership/homeownership_"
this_title <- "Homeownership"
this_caption <- "\nSource: Greater Louisville Project
    Data from the U.S. Census Bureau's American Community Survey (ACS), 2019"
this_caption_trend_graphs <- "\nSource: Greater Louisville Project
    Data from the U.S. Census Bureau's American Community Survey (ACS)"

png(path %p% "ranking.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::ranking(
  filter(housing_county, var_type == 'percent'),
  homeownership,
  year = 2019,
  race = "total",
  sex = "total",
  peers = "Current",
  order = "Descending",
  y_title = "Percent",
  plot_title = this_title %p% ", 2019",
  caption_text = this_caption,
  bar_label = TRUE,
  sigfig = 3,
  accuracy = 0.1,
  alternate_text = NULL,
  ranking_colors = TRUE)
dev.off()


png(path %p% "trend.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  filter(housing_county, var_type == 'percent'),
  homeownership,
  rollmean = 3,
  plot_title = this_title,
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


png(path %p% "maxmin.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend_maxmin(
  filter(housing_county, var_type == 'percent'),
  homeownership,
  zero_start = T,
  rollmean = 3,
  y_title = "Percentage points change",
  plot_title = this_title,
  caption_text = this_caption_trend_graphs)
dev.off()


png(path %p% "sex.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  filter(housing_county, var_type == 'percent'),
  homeownership,
  cat='sex',
  pctiles = F,
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


#Dataframe for race trend graph
housing_county_race <- pivot_wider(filter(housing_county, var_type == 'percent'), names_from = 'race', values_from = 'homeownership')

png(path %p% "race.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  housing_county_race,
  black:white,
  cat = c('Black'='black', 'White'='white', 'Hispanic'='hispanic', 'Other'='other'),
  pctiles = F,
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()

```

```{r cost-burdened households}
path <- "output_images/qop/cost_burdened/cost_burdened_"
this_title <- "Cost-Burdened Households"
this_caption <- "\nSource: Greater Louisville Project
    Data from the U.S. Census Bureau's American Community Survey (ACS), 2019"
this_caption_trend_graphs <- "\nSource: Greater Louisville Project
    Data from the U.S. Census Bureau's American Community Survey (ACS)"

png(path %p% "ranking.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::ranking(
  filter(housing_county, var_type == 'percent'),
  cost_burden,
  year = 2019,
  race = "total",
  sex = "total",
  peers = "Current",
  order = "Ascending",
  y_title = "Percent",
  plot_title = this_title %p% ", 2019",
  caption_text = this_caption,
  bar_label = TRUE,
  sigfig = 3,
  accuracy = 0.1,
  alternate_text = NULL,
  ranking_colors = TRUE)
dev.off()


png(path %p% "trend.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  filter(housing_county, var_type == 'percent'),
  cost_burden,
  rollmean = 3,
  plot_title = this_title,
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


png(path %p% "maxmin.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend_maxmin(
  filter(housing_county, var_type == 'percent'),
  cost_burden,
  zero_start = T,
  rollmean = 3,
  order='Ascending',
  y_title = "Percentage points change",
  plot_title = this_title,
  caption_text = this_caption_trend_graphs)
dev.off()


png(path %p% "sex.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  filter(housing_county, var_type == 'percent'),
  cost_burden,
  cat='sex',
  pctiles = F,
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


png(path %p% "race.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  filter(housing_county, var_type == 'percent'),
  cost_burden,
  cat = 'race',
  include_hispanic = T,
  pctiles = F,
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()