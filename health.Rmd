```{r setup}
library(glptools)
library(glpdata)
glp_load_packages(graphs = T)

showtext_auto()
font_add("Museo Sans", "MuseoSans_300.otf")
font_add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

source("helpers/graph_functions.R")
source("helpers/load_graph_specs.R")
```

```{r}
get_y_lims <- function(df, var, rm, rm_sex, rm_race, xmin, xmax, order, 
                        sex_pctiles, race_pctiles, units = "Percent",
                        categories = c("total", "sex", "race")){
  
  # Trendline
  df_single <- df %>% trend_data(var, rm, xmin, xmax)
  df_processed <- df_single

  # Max-min
  if(df_type(df) %in% c("FIPS", "MSA")){
    df_maxmin <- df %>%
      trend_data_maxmin(var, rm, xmin, xmax, order) %>%
      filter(variable %in% c("best", "worst")) %>%
      mutate(category = "total")

    df_processed %<>% bind_rows(df_maxmin)
  }

  # Sex
  if("sex" %in% categories){
    df_sex <- df %>% trend_data(var, rm_sex, xmin, xmax, cat = "sex", pctiles = sex_pctiles)
    df_processed %<>% bind_rows(df_sex)
  }

  # Race
  if("race" %in% categories){
    df_race <- df %>% trend_data(var, rm_race, xmin, xmax, cat = "race", pctiles = race_pctiles)
    df_processed %<>% bind_rows(df_race)
  }

  # FRL
  if("frl"  %in% categories){
    df_frl <- df %>% trend_data(var, rm, xmin, xmax, cat = "frl_status", pctiles = F)
    df_processed %<>% bind_rows(df_frl)
  }

  # Then use the min and max to determine y axis limits for trendline graphs.
  midpoint <- (max(df_processed[[var]], na.rm = TRUE) +
                 min(df_processed[[var]], na.rm = TRUE))/2

  border_space <- abs(.1 * midpoint)

  ylims <- c(min(df_processed[[var]], na.rm = TRUE) - border_space,
             max(df_processed[[var]], na.rm = TRUE) + border_space)

  if (units == "Percent" & ylims[2] > 100) ylims[2] <- 100

  glptools:::make_list(ylims, df_processed)
}

rm = 1
xmin = 2000
xmax = 2019
order = "descending"
rm_sex = 3
sex_pctiles = F
rm_race = 3
race_pctiles = T

t=get_y_lims(filter(natality_county, var_type == "percent"), "underweight_births", 1, 3, 3, 2003, 2019, "ascending", F, T)

t2=t$df_processed

```


```{r underweight_births}
path <- "output_images/health/underweight_births/underweight_births_"
this_title <- "Underweight Births"
this_subtitle <- "Age-adjusted"
this_caption <- "Source: Greater Louisville Project
   GLP analysis of CDC Wonder Natality data"



png(path %p% "ranking.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
ranking(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  plot_title = this_title %p% ", 2019",
  subtitle_text = this_subtitle,
  order = "Ascending",
  caption_text = this_caption)
dev.off()


png(path %p% "trend.png", 
    3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  plot_title = this_title,
  subtitle_text =  this_subtitle,
  rollmean = 3,
  ylimits = c(5, 17),
  caption_text = this_caption)
dev.off()

png(path %p% "maxmin.png", 
    3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend_maxmin(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  xmin = 2003,
  rollmean = 3,
  order = "ascending",
  ylimits = c(5, 17),
  plot_title = this_title,
  subtitle_text = this_subtitle,
  caption_text = this_caption)
dev.off()

png("output_images/health/underweight_births/underweight_births_change.png", 
    3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend_maxmin(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  zero_start = T,
  rollmean = 3,
  order = "ascending",
  y_title = "Percentage Points Change",
  plot_title = this_title,
  subtitle_text =  this_subtitle,
  caption_text = this_caption)
dev.off()



png("output_images/health/underweight_births/underweight_births_sex.png", 
    3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  cat = "sex",
  plot_title = this_title,
  subtitle_text = this_subtitle,
  rollmean = 3,
  ylimits = c(5, 17),
  pctiles = FALSE,
  caption_text = this_caption)
dev.off()


png("output_images/health/underweight_births/underweight_births_race.png", 
    3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend(
  filter(natality_county, var_type == "percent"),
  underweight_births,
  cat = "race",
  plot_title = this_title,
  subtitle_text =  this_subtitle,
  rollmean = 3,
  ylimits = c(5, 17),
  caption_text = this_caption)
dev.off()





```

```{r social_associations}
create_images(column = "variable", 
              value = c("social_associations"),
              df = glpdata:::social_associations,
              upload_graphs = T,
              upload_data   = F)
```

```{r mammography_screening}
path <- "output_images/health/mammography_screening/mammography_screening_"
this_title <- "Mammography Screenings"
this_caption <- "\nSource: Greater Louisville Project
    Data from the CMS Mapping Medicare Disparities tool, 2020"
this_caption_trend_graphs <- "\nSource: Greater Louisville Project
    Data from the CMS Mapping Medicare Disparities tool
    Percent represents Medicare enrollees (65-74) who are screened yearly"

png(path %p% "ranking.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::ranking(
  mammography_county,
  mammography_screening,
  year = 2020,
  sex = "total",
  race = "total",
  peers = "Current",
  order = "Descending",
  y_title = "Percent of Medicare enrollees (65-74) who are screened yearly",
  plot_title = this_title %p% ", 2020",
  caption_text = this_caption,
  bar_label = TRUE,
  sigfig = 3,
  accuracy = 0.1,
  alternate_text = NULL,
  ranking_colors = TRUE)
dev.off()


png(path %p% "trend.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  mammography_county, 
  mammography_screening, 
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


png(path %p% "maxmin.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
trend_maxmin(
  mammography_county,
  mammography_screening,
  zero_start = T,
  rollmean = 3,
  y_title = "Percentage Points Change",
  plot_title = this_title,
  caption_text = this_caption_trend_graphs)
dev.off()


png(path %p% "race.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::trend(
  mammography_county, 
  mammography_screening,
  cat='race',
  include_hispanic = T,
  pctiles = F,
  rollmean = 3,
  plot_title = this_title, 
  caption_text = this_caption_trend_graphs,
  y_title = "Percent")
dev.off()


```

```{r flu_vaccines}
path <- "output_images/health/flu_vaccines/flu_vaccines_"
this_title <- "Flu Vaccinations"
this_caption <- "\nSource: Greater Louisville Project
    Data from the CMS Mapping Medicare Disparities tool, 2020"
this_caption_trend_graphs <- "\nSource: Greater Louisville Project
    Data from the CMS Mapping Medicare Disparities tool
    Percent represents Medicare enrollees reimbursed for a flu vaccine"

png(path %p% "ranking.png", 3000, 2400, res = 200, bg = "transparent", type = "cairo")
glptools::ranking(
  flu_county,
  flu_shot,
  year = 2020,
  sex = "total",
  race = "total",
  peers = "Current",
  order = "Descending",
  y_title = "Percent of Medicare enrollees reimbursed for a flu vaccine",
  plot_title = this_title %p% ", 2020",
  caption_text = this_caption,
  bar_label = TRUE,
  sigfig = 3,
  accuracy = 0.1,
  alternate_text = NULL,
  ranking_colors = TRUE)
dev.off()
